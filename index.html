<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ScoRHEgami - Baseball Game Results</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div class="container">
      <header class="mb-4">
        <h1 class="text-center">ScoRHEgami Game Results</h1>
        <p class="text-center lead">
          Find baseball games by their Run-Hit-Error combinations
        </p>
      </header>

      <main>
        <div class="card mb-4">
          <div class="card-header bg-dark text-white">
            <h5 class="mb-0">Search Games by R-H-E</h5>
          </div>
          <div class="card-body">
            <form id="searchForm" onsubmit="fetchGames(event)">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="rhe-inputs-container">
                    <h6 class="mb-3">Enter R-H-E Values:</h6>

                    <div class="rhe-input-group">
                      <span class="rhe-input-label">Away Team:</span>
                      <input
                        type="number"
                        id="awayR"
                        class="form-control rhe-input"
                        min="0"
                        placeholder="R"
                        required
                      />
                      <input
                        type="number"
                        id="awayH"
                        class="form-control rhe-input"
                        min="0"
                        placeholder="H"
                        required
                      />
                      <input
                        type="number"
                        id="awayE"
                        class="form-control rhe-input"
                        min="0"
                        placeholder="E"
                        required
                      />
                    </div>

                    <div class="rhe-input-group">
                      <span class="rhe-input-label">Home Team:</span>
                      <input
                        type="number"
                        id="homeR"
                        class="form-control rhe-input"
                        min="0"
                        placeholder="R"
                        required
                      />
                      <input
                        type="number"
                        id="homeH"
                        class="form-control rhe-input"
                        min="0"
                        placeholder="H"
                        required
                      />
                      <input
                        type="number"
                        id="homeE"
                        class="form-control rhe-input"
                        min="0"
                        placeholder="E"
                        required
                      />
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="pageSize" class="form-label"
                      >Results per page</label
                    >
                    <select id="pageSize" class="form-select">
                      <option value="5">5</option>
                      <option value="10" selected>10</option>
                      <option value="20">20</option>
                      <option value="50">50</option>
                    </select>
                  </div>

                  <button type="submit" class="btn btn-primary w-100">
                    Search Games
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <div id="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading games...</p>
        </div>

        <div id="resultsContainer" style="display: none">
          <div id="noResults" style="display: none" class="alert alert-warning">
            No games found with the specified R-H-E values.
          </div>

          <div id="gamesTableContainer">
            <div class="table-responsive">
              <table class="table table-hover table-striped">
                <thead class="table-dark">
                  <tr>
                    <th>Teams</th>
                    <th>Box Score</th>
                    <th>Link</th>
                  </tr>
                </thead>
                <tbody id="gamesTableBody">
                  <!-- Games will be inserted here dynamically -->
                </tbody>
              </table>
            </div>
          </div>

          <div class="pagination-container">
            <nav aria-label="Page navigation">
              <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be inserted here dynamically -->
              </ul>
            </nav>
            <div class="text-center text-muted" id="pageInfo">
              <!-- Page info will be inserted here dynamically -->
            </div>
          </div>
        </div>
      </main>

      <footer class="mt-5 text-center text-muted">
        <p>Â© 2025 ScoRHEgami - Find unique baseball game scores</p>
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const apiUrl = "http://localhost:8000";
      // Global variables to track current state
      let currentPage = 1;
      let currentPageSize = 10;
      let currentRHE = [];
      let totalGames = 0;
      let totalPages = 0;

      function formatBoxScore(boxScore, rhe) {
        if (!boxScore || boxScore.length === 0) {
          return "<small>-</small>";
        }

        let awayBoxScore = "";
        for (let i = 0; i < (boxScore.length - 6) / 2; i++) {
          awayBoxScore += boxScore[i] + " ";
        }
        awayBoxScore += `<span class="rhe-values">${rhe[0]} ${rhe[1]} ${rhe[2]}</span>`;

        let homeBoxScore = "";
        for (let i = boxScore.length / 2; i < boxScore.length - 3; i++) {
          homeBoxScore += boxScore[i] + " ";
        }
        homeBoxScore += `<span class="rhe-values">${rhe[3]} ${rhe[4]} ${rhe[5]}</span>`;

        return `<div>${awayBoxScore}</div><div>${homeBoxScore}</div>`;
      }

      function formatDate(dateString) {
        if (!dateString) return "TBD";

        const date = new Date(dateString);
        return (
          date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          }) +
          " " +
          date.toLocaleTimeString("en-US", {
            hour: "2-digit",
            minute: "2-digit",
          })
        );
      }

      // Fetch games from API
      async function fetchGames(event) {
        if (event) event.preventDefault();

        // Get R-H-E values
        const awayR = parseInt(document.getElementById("awayR").value);
        const awayH = parseInt(document.getElementById("awayH").value);
        const awayE = parseInt(document.getElementById("awayE").value);
        const homeR = parseInt(document.getElementById("homeR").value);
        const homeH = parseInt(document.getElementById("homeH").value);
        const homeE = parseInt(document.getElementById("homeE").value);

        // Create RHE array
        currentRHE = [awayR, awayH, awayE, homeR, homeH, homeE];

        const pageSizeInput = document.getElementById("pageSize");
        currentPageSize = parseInt(pageSizeInput.value);

        document.getElementById("loading").style.display = "block";
        document.getElementById("resultsContainer").style.display = "none";

        try {
          // Build the query parameters
          const offset = (currentPage - 1) * currentPageSize;
          let params = new URLSearchParams();
          params.append("offset", offset.toString());
          params.append("count", currentPageSize.toString());

          // Add RHE as query parameters
          let rheParams = "";
          for (let i = 0; i < currentRHE.length; i++) {
            rheParams += `&rhe=${currentRHE[i]}`;
          }

          // Fetch games with RHE filter
          const gamesResponse = await fetch(
            `${apiUrl}/game?${params.toString()}${rheParams}`
          );

          if (!gamesResponse.ok) {
            throw new Error(
              `Failed to fetch games: ${gamesResponse.status} ${gamesResponse.statusText}`
            );
          }

          const games = await gamesResponse.json();

          // Get count for pagination
          const countResponse = await fetch(
            `${apiUrl}/game/count?${rheParams.substring(1)}`
          );

          if (!countResponse.ok) {
            throw new Error(
              `Failed to fetch game count: ${countResponse.status} ${countResponse.statusText}`
            );
          }

          totalGames = await countResponse.json();
          totalPages = Math.ceil(totalGames / currentPageSize);

          // Update UI
          updateGamesList(games);
          updatePagination();
        } catch (error) {
          console.error("Error fetching games:", error);
          alert("Error fetching games: " + error.message);
        } finally {
          document.getElementById("loading").style.display = "none";
          document.getElementById("resultsContainer").style.display = "block";
        }
      }

      // Update games list in the UI
      function updateGamesList(games) {
        const tableBody = document.getElementById("gamesTableBody");
        const noResults = document.getElementById("noResults");
        const gamesTableContainer = document.getElementById(
          "gamesTableContainer"
        );

        // Clear existing rows
        tableBody.innerHTML = "";

        if (games.length === 0) {
          noResults.style.display = "block";
          gamesTableContainer.style.display = "none";
          return;
        }

        noResults.style.display = "none";
        gamesTableContainer.style.display = "block";

        // Create new rows
        games.forEach((game) => {
          const tr = document.createElement("tr");

          // Format date strings
          const startTimeStr = formatDate(game.start_time);
          const endTimeStr = game.end_time ? formatDate(game.end_time) : "";

          tr.innerHTML = `
                    <td>
                        <div class="team">
                            <span class="team-name">${
                              game.away_team.name
                            }</span>
                        </div>
                        <div class="team">
                            <span class="team-name">${
                              game.home_team.name
                            }</span>
                        </div>
                        <div class="game-time">
                            ${startTimeStr}
                        </div>
                    </td>
                    <td class="box-score">
                        ${formatBoxScore(game.box_score, game.rhe)}
                    </td>
                    <td>
                        ${
                          game.bref_url
                            ? `<a href="${game.bref_url}" target="_blank" class="btn btn-sm btn-outline-primary">View Game</a>`
                            : '<span class="badge bg-secondary">No Link</span>'
                        }
                    </td>
                `;

          tableBody.appendChild(tr);
        });
      }

      // Update pagination controls
      function updatePagination() {
        const pagination = document.getElementById("pagination");
        const pageInfo = document.getElementById("pageInfo");

        // Clear existing pagination
        pagination.innerHTML = "";

        if (totalPages <= 1) {
          pageInfo.textContent =
            totalGames > 0 ? `Showing all ${totalGames} games` : "";
          return;
        }

        // Previous button
        const prevLi = document.createElement("li");
        prevLi.classList.add("page-item");
        if (currentPage === 1) {
          prevLi.classList.add("disabled");
        }
        prevLi.innerHTML = `
                <a class="page-link" href="#" aria-label="Previous" onclick="changePage(${
                  currentPage - 1
                }); return false;">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            `;
        pagination.appendChild(prevLi);

        // Page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(
          1,
          currentPage - Math.floor(maxVisiblePages / 2)
        );
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        // Adjust if we're near the end
        if (endPage - startPage + 1 < maxVisiblePages) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        // First page if not visible
        if (startPage > 1) {
          const firstLi = document.createElement("li");
          firstLi.classList.add("page-item");
          firstLi.innerHTML = `
                    <a class="page-link" href="#" onclick="changePage(1); return false;">1</a>
                `;
          pagination.appendChild(firstLi);

          if (startPage > 2) {
            const ellipsisLi = document.createElement("li");
            ellipsisLi.classList.add("page-item", "disabled");
            ellipsisLi.innerHTML = '<span class="page-link">...</span>';
            pagination.appendChild(ellipsisLi);
          }
        }

        // Visible pages
        for (let i = startPage; i <= endPage; i++) {
          const pageLi = document.createElement("li");
          pageLi.classList.add("page-item");
          if (i === currentPage) {
            pageLi.classList.add("active");
          }
          pageLi.innerHTML = `
                    <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                `;
          pagination.appendChild(pageLi);
        }

        // Last page if not visible
        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            const ellipsisLi = document.createElement("li");
            ellipsisLi.classList.add("page-item", "disabled");
            ellipsisLi.innerHTML = '<span class="page-link">...</span>';
            pagination.appendChild(ellipsisLi);
          }

          const lastLi = document.createElement("li");
          lastLi.classList.add("page-item");
          lastLi.innerHTML = `
                    <a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>
                `;
          pagination.appendChild(lastLi);
        }

        // Next button
        const nextLi = document.createElement("li");
        nextLi.classList.add("page-item");
        if (currentPage === totalPages) {
          nextLi.classList.add("disabled");
        }
        nextLi.innerHTML = `
                <a class="page-link" href="#" aria-label="Next" onclick="changePage(${
                  currentPage + 1
                }); return false;">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            `;
        pagination.appendChild(nextLi);

        // Page info
        const startItem = (currentPage - 1) * currentPageSize + 1;
        const endItem = Math.min(currentPage * currentPageSize, totalGames);
        pageInfo.textContent = `Showing ${startItem} to ${endItem} of ${totalGames} games`;
      }

      // Change page
      function changePage(page) {
        if (page < 1 || page > totalPages) {
          return;
        }

        currentPage = page;
        fetchGames();
      }

      // Load page with default values
      document.addEventListener("DOMContentLoaded", () => {
        // You can set default RHE values here if needed
        document.getElementById("awayR").value = 3;
        document.getElementById("awayH").value = 7;
        document.getElementById("awayE").value = 1;
        document.getElementById("homeR").value = 4;
        document.getElementById("homeH").value = 9;
        document.getElementById("homeE").value = 2;
      });
    </script>
  </body>
</html>
